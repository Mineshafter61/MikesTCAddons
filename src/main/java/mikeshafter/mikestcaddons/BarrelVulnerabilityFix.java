package mikeshafter.mikestcaddons;

import net.kyori.adventure.text.TextComponent;
import org.bukkit.block.BlockFace;
import org.bukkit.block.Container;
import org.bukkit.block.Sign;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;
import org.bukkit.event.player.PlayerInteractEvent;


public class BarrelVulnerabilityFix implements Listener {
  @EventHandler
  public void onBarrelOpen(PlayerInteractEvent event) {
    if (event.getClickedBlock() != null && event.getClickedBlock().getBlockData() instanceof Container) {
      for (BlockFace face : new BlockFace[] {BlockFace.NORTH, BlockFace.SOUTH, BlockFace.EAST, BlockFace.WEST, BlockFace.UP}) {
        if (event.getClickedBlock().getRelative(face) instanceof Sign sign) {
          boolean b = disallowOpen(sign);
          event.setCancelled(b);
          if (b) return;
        }
      }
    } else if (event.getAction() == Action.LEFT_CLICK_BLOCK && event.getClickedBlock() != null && event.getClickedBlock().getBlockData() instanceof Sign sign && !event.getPlayer().hasPermission("mikestcaddons.barrel")) {
      event.setCancelled(disallowOpen(sign));
    }
  }
  
  private boolean disallowOpen(Sign sign) {
    TextComponent component = (TextComponent) sign.line(1);
    return component.content().equalsIgnoreCase("barrel");
  }
}
